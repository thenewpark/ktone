import { MCPTool } from "mcp-framework";
import { z } from "zod";
import OpenAI from "openai";
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
}); // í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
const formalityRules = {
  formality: {
    "1ì ": {
      label: "ë§¤ìš° ë¹„ê²©ì‹",
      description: "ë°˜ë§ ì–´ë¯¸ì™€ ììœ ë¡œìš´ í‘œí˜„ ì‚¬ìš©. ì¶•ì•½ ë° ì´ëª¨í‹°ì½˜ í—ˆìš©.",
      features: ["-ì•„, -ì–´ ì–´ë¯¸", "ì´ëª¨ì§€, ì˜ì„±ì–´", "ì£¼ì–´ ìƒëµ", "ì¸í„°ë„·ì²´"],
      examples: ["ì´ê±° í•´", "ë°¥ ë¨¹ì—ˆì–´?", "ê³ ë§ˆì›Œìš”ğŸ˜»", "ë´ë´ìš”ã…ã…"],
      context: ["ì¹œêµ¬ ëŒ€í™”", "SNS ëŒ“ê¸€", "ìºì£¼ì–¼ ì»¤ë®¤ë‹ˆí‹°"],
    },
    "2ì ": {
      label: "ë¹„ê²©ì‹",
      description: "ì¹œê·¼í•œ í•´ìš”ì²´ ì¤‘ì‹¬. êµ¬ì–´ì  í‘œí˜„ì„ í¬í•¨.",
      features: ["-í•´ìš”", "-ì£ ", "ê°íƒ„ í‘œí˜„", "ì§ì ‘ í˜¸ì¹­"],
      examples: ["ì´ê±° í•´ë´ìš”", "ê´œì°®ì•„ìš”?", "ì–´ë”” ê°€ìš”?", "ì´ê±° ì–´ë•Œìš”?"],
      context: ["ì»¤ë®¤ë‹ˆí‹°", "ê°œì¸ ë¸”ë¡œê·¸", "ì¹œê·¼í•œ ê³ ê° ì‘ëŒ€"],
    },
    "3ì ": {
      label: "ì¤‘ë¦½ì  ê²©ì‹",
      description: "ì¼ìƒì  ì¡´ëŒ€ í‘œí˜„ ì‚¬ìš©. ì„œë¹„ìŠ¤ UI ë“±ì—ì„œ í™œìš©.",
      features: ["ê¸°ë³¸ í•´ìš”ì²´", "-í•´ìš” / -í•˜ì‹œê² ì–´ìš”", "ì‚¬ìš©ì ì¤‘ì‹¬ ì•ˆë‚´"],
      examples: ["ì•ˆë‚´ ë„ì™€ë“œë¦´ê²Œìš”", "í™•ì¸í•´ ì£¼ì„¸ìš”", "ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?"],
      context: ["ê³µì‹ ë¸”ë¡œê·¸", "ì •ë³´ì„± ì½˜í…ì¸ ", "ì•±/ì›¹ ì¸í„°í˜ì´ìŠ¤"],
    },
    "4ì ": {
      label: "ê²©ì‹",
      description: "ê³µì†í•œ í•˜ì‹­ì‹œì˜¤ì²´ ì¤‘ì‹¬. ì •ì¤‘í•˜ê³  ëª…í™•í•œ ì–´ì¡°.",
      features: ["-ì‹­ì‹œì˜¤", "-ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤", "ê°„ê²°/ëª…í™•í•œ ì•ˆë‚´", "ê²©ì‹ ë†’ìŒ"],
      examples: ["ë“±ë¡í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤", "í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤", "ë¬¸ì˜ ì£¼ì‹­ì‹œì˜¤"],
      context: ["ê³µê³µê¸°ê´€", "ê³µì‹ ê³µì§€", "ê¸°ì—… ê³ ê°ì„¼í„°"],
    },
    "5ì ": {
      label: "ë§¤ìš° ê²©ì‹",
      description: "ê´€ë£Œì  í‘œí˜„ ë° ê·¹ì¡´ì¹­. ëª…ì‚¬í˜• ì„œìˆ  ê°•ì¡°.",
      features: ["ëª…ì‚¬í™”", "ì²´ì–¸í˜• í‘œí˜„", "ì£¼ì–´ ìƒëµ", "ê°•ì¡°ëœ ê°ê´€ì„±"],
      examples: ["í™•ì¸ ìš”ë§", "íšŒì‹  ë°”ëë‹ˆë‹¤", "ì¡°ì¹˜ ë°”ëë‹ˆë‹¤"],
      context: ["ë³´ê³ ì„œ", "ê³µë¬¸", "í–‰ì • ë¬¸ì„œ", "ì •ì±… ë¬¸ì„œ"],
    },
  },
};
function buildFormalityDiagnosisPrompt(input) {
  return `
    [ì§€ì¹¨]
    ì•„ë˜ í…ìŠ¤íŠ¸ì˜ ê²©ì‹ ìˆ˜ì¤€ì´ ì–´ë–¤ ë‹¨ê³„(1~5)ì— ê°€ê¹Œìš´ì§€ íŒë‹¨í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•´ ì£¼ì„¸ìš”.

    - ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì´ 1~5ì  ì¤‘ ì–´ë–¤ ê²©ì‹ ì ìˆ˜ì— ê°€ê¹Œìš´ì§€ ì§„ë‹¨í•´ ì£¼ì„¸ìš”.
    - ì ìˆ˜ ê¸°ì¤€: 1 (ë§¤ìš° ë¹„ê²©ì‹) ~ 5 (ë§¤ìš° ê²©ì‹)
    - ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë¥¼ ìš”ì•½í•´ ì£¼ì„¸ìš”.

    Formality ê¸°ì¤€ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    ${["1ì ", "2ì ", "3ì ", "4ì ", "5ì "]
      .map((score) => {
        const f = formalityRules.formality[score];
        return `
          [Formality ${score}]
          - ì´ë¦„: ${f.label}
          - ì„¤ëª…: ${f.description}
          - íŠ¹ì§•: ${f.features.join(", ")}
          - ì˜ˆì‹œ: "${f.examples[0]}"`;
      })
      .join("\n\n")}

    [í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    - ì˜ˆì¸¡ ì ìˆ˜: N
    - ì˜ˆì¸¡ ì´ë¦„: ê²©ì‹ ìˆ˜ì¤€ ì´ë¦„
    - ì´ìœ : {ë‚´ìš©}
  `.trim();
}
function buildFormalityRewritePrompt(score, input) {
  const rule = formalityRules.formality[score];
  return `
    [ì§€ì¹¨]
    [ì›ë³¸ í…ìŠ¤íŠ¸]ë¥¼ ì•„ë˜ ê²©ì‹ ìˆ˜ì¤€ìœ¼ë¡œ ë°”ê¾¸ë˜, **ì˜ë¯¸ëŠ” ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”**.
    ì¦‰, ì •ë³´, ì£¼ì–´, ë©”ì‹œì§€ì˜ í•µì‹¬ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  **ë¬¸ì²´(í†¤ê³¼ ìŠ¤íƒ€ì¼)ë§Œ ë°”ê¿” ì£¼ì„¸ìš”**.

    - í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì„ ì£¼ì–´ì§„ ê²©ì‹ ì ìˆ˜ (${score})ì— ë§ê²Œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.
    - ë‹¨, ë¬¸ì¥ì˜ **í•µì‹¬ ì˜ë¯¸ë‚˜ ì •ë³´ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”**.
    - ì „ì²´ ê¸€ì´ ê²©ì‹ìƒ ìì—°ìŠ¤ëŸ½ê³  ì¼ê´€ì„± ìˆê²Œ ì½íˆë„ë¡ ì¡°ì •í•˜ì„¸ìš”.
    - ê°€ëŠ¥í•œ í•œ **ìµœì†Œí•œì˜ ìˆ˜ì •**ìœ¼ë¡œ ê²©ì‹ ë³€í™”ë¥¼ ìœ ë„í•˜ì„¸ìš”.

    [Formality ${score}ë²ˆ í†¤ ë³€í™˜ ìš”ì²­]
    - í†¤ ì´ë¦„: ${rule.label}
    - ì„¤ëª…: ${rule.description}
    - íŠ¹ì§•: ${rule.features.join(", ")}
    - ì˜ˆì‹œ ë¬¸ì¥: "${rule.examples.join(", ")}"

    [ì›ë³¸ í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ìˆ˜ì •ëœ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì„œ ì¶œë ¥í•˜ì„¸ìš”.
  `.trim();
}
export class KFormalityTool extends MCPTool {
  constructor() {
    super(...arguments);
    this.name = "kformality";
    this.description = "í•œêµ­ì–´ ë¬¸ì¥ì˜ ë¹„ê²©ì‹-ê²©ì‹ ìˆ˜ì¤€ì„ ë¶„ì„í•˜ê±°ë‚˜, ì§€ì •ëœ ì ìˆ˜ ìˆ˜ì¤€ìœ¼ë¡œ ë¦¬ë¼ì´íŒ…í•©ë‹ˆë‹¤.";
    this.schema = {
      text: {
        type: z.string(),
        description: "ë¶„ì„í•  í•œêµ­ì–´ ë¬¸ì¥",
      },
      mode: {
        type: z.enum(["diagnose", "rewrite"]),
        description: "ëª¨ë“œ: diagnose ë˜ëŠ” rewrite",
      },
      formality: {
        type: z.union([z.literal("1"), z.literal("2"), z.literal("3"), z.literal("4"), z.literal("5")]).optional(),
        description: "ëª©í‘œ ê²©ì‹ ì ìˆ˜ (1~5)",
      },
    };
  }
  async execute({ text, mode, formality }) {
    if (mode === "diagnose") {
      const messages = [
        {
          role: "system",
          content:
            "ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì˜ ë¹„ê²©ì‹-ê²©ì‹ ìˆ˜ì¤€ì„ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê° ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.",
        },
        {
          role: "user",
          content: buildFormalityDiagnosisPrompt(text),
        },
      ];
      const response = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages,
      });
      return response.choices[0].message.content;
    }
    if (mode === "rewrite") {
      if (!formality) throw new Error("rewrite ëª¨ë“œì—ì„œëŠ” formality ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const formalityKey = `${formality}ì `;
      if (!["1ì ", "2ì ", "3ì ", "4ì ", "5ì "].includes(formalityKey)) {
        throw new Error("ìœ íš¨í•œ formality ê°’ì´ ì•„ë‹™ë‹ˆë‹¤.");
      }
      const messages = [
        {
          role: "system",
          content:
            "ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì„ ì§€ì •ëœ ê²©ì‹ ì ìˆ˜(1~5ì  ìŠ¤í™íŠ¸ëŸ¼: ë¹„ê²©ì‹ â†” ê²©ì‹)ì— ë§ê²Œ 'ë¬¸ì²´ë§Œ' ì¬ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì œê³µí•œ ë¬¸ì¥ì„ ê²©ì‹ ì ìˆ˜ ê¸°ì¤€ì— ë”°ë¼ **ë§íˆ¬, ì–´íˆ¬, í‘œí˜„ ë°©ì‹ë§Œ ë³€ê²½**í•˜ì„¸ìš”. **ì˜ë¯¸ ë³€í˜•ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.** ë¬¸ì¥ì˜ ì •ë³´ êµ¬ì¡°(ì£¼ì–´, ëª©ì ì–´, ë™ì‚¬)ëŠ” ë°˜ë“œì‹œ ìœ ì§€ë˜ì–´ì•¼ í•˜ë©°, ì–´ë¯¸/í˜•ì‹ë§Œ ë³€ê²½í•˜ì„¸ìš”.",
        },
        {
          role: "user",
          content: buildFormalityRewritePrompt(formalityKey, text),
        },
      ];
      const response = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages,
      });
      return response.choices[0].message.content;
    }
    throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œì…ë‹ˆë‹¤. diagnose ë˜ëŠ” rewrite ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  }
}
export default KFormalityTool;

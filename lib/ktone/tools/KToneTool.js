import { MCPTool } from "mcp-framework";
import { z } from "zod";
import OpenAI from "openai";

const styleRules = {
  style: {
    "5ì ": {
      label: "ê·¹íˆ ì‚¬íšŒì •ì„œì ",
      nng_mapping: {
        funny_serious: "Funny",
        enthusiastic_fact: "Enthusiastic",
      },
      description: "ì¹œê·¼í•˜ê³  ê°ì„±ì ì´ë©°, ìœ ì¾Œí•¨ê³¼ ë”°ëœ»í•¨ì„ ê°•ì¡°í•˜ëŠ” ìŠ¤íƒ€ì¼",
      features: [
        "ê°íƒ„ì‚¬",
        "ì´ëª¨ì§€, ë¬¸ì¥ ë¶€í˜¸ ì‚¬ìš©",
        "ê°ì • ê°•ì¡° í‘œí˜„",
        "í•´ì²´ ì–´ë¯¸ (-ì•¼, -í•´)",
        "ë³´ì¡°ì‚¬ ìƒëµ & êµ¬ì–´ì²´ ë¶€ì‚¬(ë§ì•„, ê·¸ëŸ¼)",
        "ë³´ì¡°ìš©ì–¸ (-í•˜ì, -ì¤˜)",
        "ìš¸íƒ€ë¦¬ì–´, ì£¼ì € í‘œí˜„(ìˆì–ì•„, ì €ê¸°)",
        "ë¹„í‘œì¤€ì–´ ì‚¬ìš© ê°€ëŠ¥",
        "ì¹œê·¼í•œ ë§íˆ¬",
      ],
      examples: [
        "í—‰ ğŸ˜¢ ì ‘ì†ì´ ì ì‹œ ì•ˆ ë  ìˆ˜ ìˆì–´ìš”~ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”~!",
        "ì•—! ë¬¸ì œê°€ ìƒê²¼ë„¤ìš” ğŸ’¦ ê¸ˆë°© í•´ê²°í•´ë“œë¦´ê²Œìš” :)",
        "ì£¼ë°© ì „ë“± ë¬´ìŠ¨ ìƒ‰ì´ì•¼~? ğŸ˜Š",
        "ê¸°ë§ ì–¸ì œì•¼? ğŸ˜…",
      ],
    },
    "4ì ": {
      label: "ì‚¬íšŒì •ì„œì ",
      nng_mapping: {
        funny_serious: "Slightly funny",
        enthusiastic_fact: "Slightly enthusiastic",
      },
      description: "ê³µê° í‘œí˜„ì´ ë‘ë“œëŸ¬ì§€ê³ , ì •ì„œì ìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ í‘œí˜„ì„ ì‚¬ìš©í•˜ëŠ” ìŠ¤íƒ€ì¼",
      features: [
        "ë¶€ë“œëŸ¬ìš´ ë§íˆ¬",
        "ì™„ì¶©ì–´, ê³µê° ë¬¸êµ¬ í¬í•¨",
        "ìœ ì—°í•œ ì¢…ê²° ì–´ë¯¸",
        "ë¶€ë“œëŸ¬ìš´ ìš”ì²­ (-ì£¼ì„¸ìš”, -ì¤„ë˜ìš”?)",
        "ì‚¬ê³¼/ë°°ë ¤ í‘œí˜„ í¬í•¨(ì£„ì†¡í•˜ì§€ë§Œ, ì‹¤ë¡€í•©ë‹ˆë‹¤)",
        "ê²¸ì–‘ì–´ ì‚¬ìš©",
      ],
      examples: [
        "ì ‘ì†ì´ ì ì‹œ ì›í™œí•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!",
        "ì•—, ì—°ê²°ì´ ëŠê²¼ë„¤ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš” :)",
        "ì£¼ë°© ì „ë“±ì´ ë¬´ìŠ¨ ìƒ‰ì´ì—ìš”?",
        "í˜¹ì‹œ ì´ë²ˆ í•™ê¸° ê¸°ë§ê³ ì‚¬ ê¸°ê°„ì´ ì–¸ì œì¸ê°€ìš”?",
      ],
    },
    "3ì ": {
      label: "ì¤‘ë¦½",
      nng_mapping: {
        funny_serious: "Neutral",
        enthusiastic_fact: "Neutral",
      },
      description: "ê³µê°ê³¼ ê³¼ì—…ì´ ê· í˜•ì¡íŒ ì¤‘ë¦½ì ì¸ ìŠ¤íƒ€ì¼",
      features: [
        "ë°°ë ¤ í‘œí˜„ í¬í•¨",
        "ë„ˆë¬´ ë”±ë”±í•˜ì§€ ì•ŠìŒ",
        "ì„¤ëª…ê³¼ ê°ì •ì˜ ê· í˜•",
        "ì´ëª¨ì§€, ê³¼ì¥ëœ ë¬¸ì¥ ë¶€í˜¸ í¬í•¨í•˜ì§€ ì•ŠìŒ",
        "ì¼ë°˜ í˜¸ì¹­, ê²¸ì–‘ì–´ ì‚¬ìš©",
        "ê°„ì ‘ í‘œí˜„(-í•´ì£¼ì‹¤ë˜ìš”?) ì‚¬ìš©",
      ],
      examples: [
        "ì ì‹œ ì ‘ì†ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆì–´ìš”. ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤.",
        "ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”.",
        "ì£¼ë°© ì „ë“±ì´ ë¬´ìŠ¨ ìƒ‰ì¸ê°€ìš”? ",
        "ì´ë²ˆ í•™ê¸° ê¸°ë§ê³ ì‚¬ ê¸°ê°„ì´ ì–¸ì œì¸ê°€ìš”?",
      ],
    },
    "2ì ": {
      label: "ê³¼ì—…ì§€í–¥ì ",
      nng_mapping: {
        funny_serious: "Serious",
        enthusiastic_fact: "Slightly matter-of-fact",
      },
      description: "ì •ì¤‘í•˜ì§€ë§Œ ê°ì •ì€ ì ˆì œëœ í‘œí˜„ì„ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ ì „ë‹¬ ì¤‘ì‹¬ì  ìŠ¤íƒ€ì¼",
      features: [
        "ì„¤ëª… ì¤‘ì‹¬",
        "ê²©ì‹ ìˆëŠ” í‘œí˜„",
        "ê°ì •ì–´, ìœ ë¨¸ ë°°ì œ",
        "ì™„ê³¡ì–´ë²•",
        "ê°„ì ‘ ì •ì¤‘ì²´(-ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤, -ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?)",
        "ì„ ì–´ë§ì–´ë¯¸ -ì‹œ- ì ì ˆ ì‚¬ìš©(í•´ì£¼ì‹œê² ì–´ìš” X, í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤ O)",
        "ê°„ì ‘ í‘œí˜„(ì£„ì†¡í•˜ì§€ë§Œ -í•´ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì„¸ìš”?) ì‚¬ìš©",
      ],
      examples: [
        "ì¼ì‹œì ìœ¼ë¡œ ì ‘ì†ì´ ì›í™œí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ìš©ì— ì°¸ê³  ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
        "ìš”ì²­í•˜ì‹  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
        "ì£¼ë°© ì „ë“±ì´ ë¬´ìŠ¨ ìƒ‰ì¸ì§€ ì•Œë ¤ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.",
        "ì´ë²ˆ í•™ê¸° ê¸°ë§ê³ ì‚¬ ê¸°ê°„ì„ ì•Œë ¤ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?",
      ],
    },
    "1ì ": {
      label: "ê·¹íˆ ê³¼ì—…ì§€í–¥ì ",
      nng_mapping: {
        funny_serious: "Serious",
        enthusiastic_fact: "Matter-of-fact",
      },
      description: "ê±´ì¡°í•˜ê³  ì„¤ëª…ì ì´ë©° ê°ì • í‘œí˜„ ì—†ì´ ê¸°ëŠ¥ ì „ë‹¬ì—ë§Œ ì§‘ì¤‘í•˜ëŠ” ìŠ¤íƒ€ì¼",
      features: [
        "ê±´ì¡°í•œ ëª…ì‚¬í˜• ì§€ì‹œë¬¸(í™•ì¸ ë°”ëë‹ˆë‹¤, íšŒì‹  ë°”ëë‹ˆë‹¤)",
        "ê°ì • í‘œí˜„, ì™„ì¶©ì–´, ì´ëª¨ì§€ ì—†ìŒ",
        "ê¸°ëŠ¥ì  ì–´íœ˜ ì‚¬ìš©",
        "ë³´ì¡° ìš©ì–¸, ê°„ì ‘ í‘œí˜„ ìµœì†Œí™”",
        "ë”±ë”±í•œ ì¢…ê²°ì–´ë¯¸",
        "ì£¼ì–´ ìƒëµ í˜¹ì€ ì¶•ì•½",
      ],
      examples: [
        "ì‹œìŠ¤í…œ ì ê²€ìœ¼ë¡œ ì¸í•´ ì ‘ì†ì´ ì œí•œë©ë‹ˆë‹¤.",
        "ì•±ì„ ì¢…ë£Œí•œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.",
        "ì£¼ë°© ì „ë“± ìƒ‰ìƒ í™•ì¸ ë°”ëë‹ˆë‹¤.",
        "ì´ë²ˆ í•™ê¸° ê¸°ë§ê³ ì‚¬ ê¸°ê°„ í™•ì¸ ë°”ëë‹ˆë‹¤.",
      ],
    },
  },
};

const formalityRules = {
  formality: {
    "5ì ": {
      label: "ë§¤ìš° ë¹„ê²©ì‹",
      description: "ë°˜ë§ ì–´ë¯¸ì™€ ììœ ë¡œìš´ í‘œí˜„ ì‚¬ìš©. ì¶•ì•½ ë° ì´ëª¨í‹°ì½˜ í—ˆìš©.",
      features: [
        "-ì•„, -ì–´, -ë‹ˆ, -ëƒ ë“±ì˜ ë°˜ë§ ì–´ë¯¸ ì‚¬ìš©",
        "ì´ëª¨ì§€, ì˜ì„±ì–´",
        "ì£¼ì²´ ìƒëµ, ì¶•ì•½ ë§ìŒ",
        "ì£¼ì–´ ìƒëµ",
        "ì¸í„°ë„·ì²´",
      ],
      examples: ["ì´ê±° í•´", "ë°¥ ë¨¹ì—ˆì–´?", "ê³ ë§ˆì›Œìš”ğŸ˜»", "ë´ë´ìš”ã…ã…", "ì£¼ë°© ì „ë“± ë¬´ìŠ¨ ìƒ‰ì´ì•¼?", "ê¸°ë§ ì–¸ì œì•¼?"],
    },
    "4ì ": {
      label: "ë¹„ê²©ì‹",
      description: "ì¹œê·¼í•œ í•´ìš”ì²´ ì¤‘ì‹¬. êµ¬ì–´ì  í‘œí˜„ì„ í¬í•¨.",
      features: ["-í•´ìš”, -ì£ , -í–ˆì–´ìš” ë“± ì¹œê·¼í•œ í•´ìš”ì²´", "êµ¬ì–´ì  í‘œí˜„ ìœ ì§€", "ì§ì ‘ í˜¸ì¹­ í¬í•¨ ê°€ëŠ¥"],
      examples: [
        "ì´ê±° í•´ë´ìš”",
        "ê´œì°®ì•„ìš”?",
        "ì–´ë”” ê°€ìš”?",
        "ì´ê±° ì–´ë•Œìš”?",
        "ì£¼ë°© ì „ë“± ë¬´ìŠ¨ ìƒ‰ì´ì—ìš”?",
        "ê¸°ë§ê³ ì‚¬ ì–¸ì œì˜ˆìš”?",
      ],
    },
    "3ì ": {
      label: "ì¤‘ë¦½ì  ê²©ì‹",
      description: "ì¼ìƒì  ì¡´ëŒ€ í‘œí˜„ ì‚¬ìš©. ì„œë¹„ìŠ¤ UI ë“±ì—ì„œ í™œìš©.",
      features: ["-í•´ìš” ë“± ê¸°ë³¸ í•´ìš”ì²´", "ì¼ìƒì  ì¡´ëŒ€ í‘œí˜„ ìœ ì§€", "ì‚¬ìš©ì ì¤‘ì‹¬ ì•ˆë‚´ ë¬¸ì¥ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í‘œí˜„"],
      examples: [
        "ì•ˆë‚´ ë„ì™€ë“œë¦´ê²Œìš”",
        "í™•ì¸í•´ ì£¼ì„¸ìš”",
        "ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?",
        "ì£¼ë°© ì „ë“±ì´ ë¬´ìŠ¨ ìƒ‰ì¸ê°€ìš”?",
        "ê¸°ë§ê³ ì‚¬ ì¼ì •ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?",
      ],
    },
    "2ì ": {
      label: "ê²©ì‹",
      description: "ê³µì†í•œ í•˜ì‹­ì‹œì˜¤ì²´ ì¤‘ì‹¬. ì •ì¤‘í•˜ê³  ëª…í™•í•œ ì–´ì¡°.",
      features: [
        "-í•˜ì‹­ì‹œì˜¤, -ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤ ë“± ê³µì†í•œ í•˜ì‹­ì‹œì˜¤ì²´",
        "ë†’ì€ ê²©ì‹ì„ ìœ ì§€í•˜ëŠ” ì •ì¤‘í•œ í‘œí˜„",
        "ê°„ê²°í•˜ê³  ê³µì‹ì ì¸ ì•ˆë‚´ ë¬¸ì¥ í‘œí˜„",
      ],
      examples: [
        "ë“±ë¡í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤",
        "í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤",
        "ë¬¸ì˜ ì£¼ì‹­ì‹œì˜¤",
        "ì£¼ë°© ì „ë“±ì˜ ìƒ‰ìƒ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
        "ê¸°ë§ê³ ì‚¬ ì¼ì • í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
      ],
    },
    "1ì ": {
      label: "ë§¤ìš° ê²©ì‹",
      description: "ê´€ë£Œì  í‘œí˜„ ë° ê·¹ì¡´ì¹­. ëª…ì‚¬í˜• ì„œìˆ  ê°•ì¡°.",
      features: [
        "ëª…ì‚¬í™”",
        "ê°•ì¡°ëœ ê°ê´€ì„±",
        "ê³µì‹ ì„œë©´ìš© í‘œí˜„",
        "ê´€ë£Œì  í‘œí˜„ ë° ê·¹ì¡´ì¹­ í‘œí˜„ ì‚¬ìš©",
        "ì£¼ì–´ ìƒëµ ë° ëª…ì‚¬í˜• ì„œìˆ  ê°•ì¡°",
      ],
      examples: [
        "í™•ì¸ ìš”ë§",
        "íšŒì‹  ë°”ëë‹ˆë‹¤",
        "ì¡°ì¹˜ ë°”ëë‹ˆë‹¤",
        "ì£¼ë°© ì „ë“± ìƒ‰ìƒ í™•ì¸ ë°”ëë‹ˆë‹¤.",
        "ê¸°ë§ê³ ì‚¬ ì¼ì • í™•ì¸ í›„ íšŒì‹  ë°”ëë‹ˆë‹¤.",
      ],
    },
  },
};

function buildStyleDiagnosisPrompt(input) {
  return `
    [ì§€ì¹¨]
    ì•„ë˜ í…ìŠ¤íŠ¸ê°€ ì–´ë–¤ style ì ìˆ˜ì— ê°€ê¹Œìš´ì§€ 1~5ì ìœ¼ë¡œ íŒë‹¨í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•´ ì£¼ì„¸ìš”.

    - ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì´ 1~5ì  ì¤‘ ì–´ë–¤ ìŠ¤íƒ€ì¼ ì ìˆ˜ì— ê°€ê¹Œìš´ì§€ ì§„ë‹¨í•´ ì£¼ì„¸ìš”.
    - ì ìˆ˜ ê¸°ì¤€: 1 (ê·¹íˆ ê³¼ì—…ì§€í–¥ì ) ~ 5 (ê·¹íˆ ì‚¬íšŒì •ì„œì )
    - ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë¥¼ ìš”ì•½í•´ ì£¼ì„¸ìš”.

    Style ê¸°ì¤€ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    ${["1ì ", "2ì ", "3ì ", "4ì ", "5ì "]
      .map((style) => {
        const s = styleRules.style[style];
        return `
          [Style ${style}]
          - ì´ë¦„: ${s.label}
          - ì„¤ëª…: ${s.description}
          - Tone ê¸°ì¤€(ë‹ìŠ¨ë…¸ë¨¼ê·¸ë£¹ ë³´ì´ìŠ¤ ì•¤ í†¤): Funnyâ€“Serious: ${
            s.nng_mapping.funny_serious
          }, Enthusiasticâ€“Matter-of-fact: ${s.nng_mapping.enthusiastic_fact}
          - íŠ¹ì§•: ${s.features.join(", ")}
          - ì˜ˆì‹œ: "${s.examples[0]}"
          `;
      })
      .join("\n")}

    [í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë§Œ ê°„ê²°í•˜ê²Œ ì¶œë ¥í•´ì£¼ì„¸ìš”. 
    - ì˜ˆì¸¡ ì ìˆ˜: N
    - ì˜ˆì¸¡ ì´ë¦„: ìŠ¤íƒ€ì¼ ì´ë¦„
    - ì´ìœ : {ë‚´ìš©}
    `;
}
function buildFormalityDiagnosisPrompt(input) {
  return `
    [ì§€ì¹¨]
    ì•„ë˜ í…ìŠ¤íŠ¸ì˜ ê²©ì‹ ìˆ˜ì¤€ì´ ì–´ë–¤ ë‹¨ê³„(1~5)ì— ê°€ê¹Œìš´ì§€ íŒë‹¨í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•´ ì£¼ì„¸ìš”.

    - ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì´ 1~5ì  ì¤‘ ì–´ë–¤ ê²©ì‹ ì ìˆ˜ì— ê°€ê¹Œìš´ì§€ ì§„ë‹¨í•´ ì£¼ì„¸ìš”.
    - ì ìˆ˜ ê¸°ì¤€: 1 (ë§¤ìš° ê²©ì‹) ~ 5 (ë§¤ìš° ë¹„ê²©ì‹)
    - ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë¥¼ ìš”ì•½í•´ ì£¼ì„¸ìš”.

    Formality ê¸°ì¤€ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    ${["1ì ", "2ì ", "3ì ", "4ì ", "5ì "]
      .map((score) => {
        const f = formalityRules.formality[score];
        return `
          [Formality ${score}]
          - ì´ë¦„: ${f.label}
          - ì„¤ëª…: ${f.description}
          - íŠ¹ì§•: ${f.features.join(", ")}
          - ì˜ˆì‹œ: "${f.examples[0]}"`;
      })
      .join("\n\n")}

    [í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë§Œ ê°„ê²°í•˜ê²Œ ì¶œë ¥í•´ì£¼ì„¸ìš”. 
    - ì˜ˆì¸¡ ì ìˆ˜: N
    - ì˜ˆì¸¡ ì´ë¦„: ê²©ì‹ ìˆ˜ì¤€ ì´ë¦„
    - ì´ìœ : {ë‚´ìš©}
  `.trim();
}
function buildFormalityRewritePrompt(formalityScore, input) {
  const formalityRule = formalityRules.formality[formalityScore];

  return `
    [ì§€ì¹¨]
    [ì›ë³¸ í…ìŠ¤íŠ¸]ì„ ì•„ë˜ ê²©ì‹ ìˆ˜ì¤€ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.
    **ë‹¨, ë¬¸ì¥ì˜ **í•µì‹¬ ì˜ë¯¸ë‚˜ ì •ë³´ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”**.
    ì¦‰, ì •ë³´, ì£¼ì–´, ë©”ì‹œì§€ì˜ í•µì‹¬ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  **ë¬¸ì²´(í†¤ê³¼ ìŠ¤íƒ€ì¼)ë§Œ ë°”ê¿” ì£¼ì„¸ìš”**.

    - ê° ë¬¸ì¥ì„ ì£¼ì–´ì§„ ê²©ì‹ ì ìˆ˜ (${formalityScore})ì— ë§ê²Œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.
    - ë‹¨, ë¬¸ì¥ì˜ **í•µì‹¬ ì˜ë¯¸ë‚˜ ì •ë³´ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”**.
    - ì „ì²´ ê¸€ì´ ìŠ¤íƒ€ì¼ìƒ ìì—°ìŠ¤ëŸ½ê³  ì¼ê´€ì„± ìˆê²Œ ì½íˆë„ë¡ ì¡°ì •í•˜ì„¸ìš”.
    - ê°€ëŠ¥í•œ í•œ **ìµœì†Œí•œì˜ ìˆ˜ì •**ìœ¼ë¡œ ìµœëŒ€í•œì˜ ê²©ì‹ ë³€í™”ë§Œ ìœ ë„í•˜ì„¸ìš”.

    [Formality ${formalityScore}ë²ˆ í†¤ ë³€í™˜ ìš”ì²­]
    - í†¤ ì´ë¦„: ${formalityRule.label}
    - ì„¤ëª…: ${formalityRule.description}
    - íŠ¹ì§•: ${formalityRule.features.join(", ")}
    - ì˜ˆì‹œ ë¬¸ì¥: "${formalityRule.examples.join(", ")}"

    [ì›ë³¸ í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ìˆ˜ì •ëœ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì„œ ì¶œë ¥í•˜ì„¸ìš”.
    ìˆ˜ì •í•œ ë¶€ë¶„ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì´ìœ ë¥¼ ë§ë¶™ì—¬ ì£¼ì„¸ìš”.
  `.trim();
}

function buildStyleRewritePrompt(style, input) {
  const rule = styleRules.style[style];
  return `
    [ì§€ì¹¨]
    [ì›ë³¸ í…ìŠ¤íŠ¸]ì„ ì•„ë˜ ìŠ¤íƒ€ì¼ì˜ ë§íˆ¬ì™€ ë¶„ìœ„ê¸°ë¡œ ë°”ê¿”ì£¼ì„¸ìš”. 
    **ë‹¨, ë¬¸ì¥ì˜ **í•µì‹¬ ì˜ë¯¸ë‚˜ ì •ë³´ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”**.
    ì¦‰, ì •ë³´, ì£¼ì–´, ë©”ì‹œì§€ì˜ í•µì‹¬ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  **ë¬¸ì²´(í†¤ê³¼ ìŠ¤íƒ€ì¼)ë§Œ ë°”ê¿” ì£¼ì„¸ìš”**.
    ë¬¸ì¥ì˜ ê²©ì‹ ìˆ˜ì¤€ë„ ê·¸ëŒ€ë¡œ ìœ ì§€í•´ ì£¼ì„¸ìš”. 

    - í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì„ ì£¼ì–´ì§„ ìŠ¤íƒ€ì¼ ì ìˆ˜ (${rule.label}, ${rule.description})ì— ë§ê²Œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”. 
    - ì£¼ì–´ì§„ ìŠ¤íƒ€ì¼ì˜ íŠ¹ì§• (${rule.features.join(", ")})ì„ ì˜ ì‚´ë ¤ì£¼ì„¸ìš”. ë‹¨, ë¬¸ì¥ì˜ ê²©ì‹ ìˆ˜ì¤€ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•´ ì£¼ì„¸ìš”. 
    - ë‹¨, ë¬¸ì¥ì˜ **í•µì‹¬ ì˜ë¯¸ë‚˜ ì •ë³´ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”**.
    - ì „ì²´ ê¸€ì´ ìŠ¤íƒ€ì¼ìƒ ìì—°ìŠ¤ëŸ½ê³  ì¼ê´€ì„± ìˆê²Œ ì½íˆë„ë¡ ì¡°ì •í•˜ì„¸ìš”.

    [Style ${style}ë²ˆ í†¤ ë³€í™˜ ìš”ì²­]
    - í†¤ ì´ë¦„: ${rule.label}
    - ì„¤ëª…: ${rule.description}
    - ìŠ¤íƒ€ì¼ ê¸°ì¤€ (NNG): Funnyâ€“Serious: ${rule.nng_mapping.funny_serious}, Enthusiasticâ€“Matter-of-fact: ${
    rule.nng_mapping.enthusiastic_fact
  }
    - íŠ¹ì§•: ${rule.features.join(", ")}
    - ì˜ˆì‹œ ë¬¸ì¥: "${rule.examples[0]}"

    [ì›ë³¸ í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ìˆ˜ì •ëœ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì„œ ì¶œë ¥í•˜ì„¸ìš”.
    ìˆ˜ì •í•œ ë¶€ë¶„ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì´ìœ ë¥¼ ë§ë¶™ì—¬ ì£¼ì„¸ìš”.
    `;
}
export class KToneTool extends MCPTool {
  constructor() {
    super(...arguments);
    this.name = "ktone";
    this.description = "í…ìŠ¤íŠ¸ì˜ í†¤ì„ ë¶„ì„í•˜ê±°ë‚˜, ì§€ì •í•œ í†¤ìœ¼ë¡œ ë¦¬ë¼ì´íŒ…í•©ë‹ˆë‹¤.";
    this.schema = {
      text: {
        type: z.string(),
        description: "ë¶„ì„í•  í•œêµ­ì–´ ë¬¸ì¥",
      },
      mode: {
        type: z.enum(["diagnose", "rewrite"]),
        description: "ëª¨ë“œ: diagnose ë˜ëŠ” rewrite",
      },
      style: {
        type: z.union([z.literal("1"), z.literal("2"), z.literal("3"), z.literal("4"), z.literal("5")]).optional(),
        description: "ëª©í‘œ ìŠ¤íƒ€ì¼ ì ìˆ˜ (1~5)",
      },
      formality: {
        type: z.union([z.literal("1"), z.literal("2"), z.literal("3"), z.literal("4"), z.literal("5")]).optional(),
        description: "ëª©í‘œ ê²©ì‹ ì ìˆ˜ (1~5)",
      },
    };
  }
  async execute({ text, style, mode, formality, apiKey }) {
    const openai = new OpenAI({
      apiKey,
    }); // í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°

    if (mode === "diagnose") {
      // 1 ê²©ì‹ í†¤ ë¶„ì„
      const formalityMessages = [
        {
          role: "system",
          content: `
          ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì˜ ë¹„ê²©ì‹-ê²©ì‹ ìˆ˜ì¤€ì„ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
          ê° ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
          `,
        },
        {
          role: "user",
          content: buildFormalityDiagnosisPrompt(text),
        },
      ];
      const formalityResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: formalityMessages,
      });
      const formalityResult = formalityResponse.choices[0].message.content ?? "";

      // 2 ìŠ¤íƒ€ì¼ í†¤ ë¶„ì„
      const styleMessages = [
        {
          role: "system",
          content: `
          ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì˜ ìŠ¤íƒ€ì¼ì„ 1~5ì ì˜ ìŠ¤í™íŠ¸ëŸ¼(ê³¼ì—…ì§€í–¥ì  â†” ì‚¬íšŒì •ì„œì )ìœ¼ë¡œ í‰ê°€í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
          ê° ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. 
          `,
        },
        {
          role: "user",
          content: buildStyleDiagnosisPrompt(formalityResult),
        },
      ];
      const styleResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: styleMessages,
      });
      const styleResult = styleResponse.choices[0].message.content ?? "";
      return `ê²©ì‹ ìˆ˜ì¤€ ì§„ë‹¨ ê²°ê³¼ \n ${formalityResult}\n\n ìŠ¤íƒ€ì¼ ì§„ë‹¨ ê²°ê³¼ \n ${styleResult}`;
    }
    if (mode === "rewrite") {
      // 1 ê²©ì‹ í†¤ ë³€í™˜
      if (!formality) throw new Error("rewrite ëª¨ë“œì—ì„œëŠ” formality ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const formalityKey = `${formality}ì `;
      if (!["1ì ", "2ì ", "3ì ", "4ì ", "5ì "].includes(formalityKey)) {
        throw new Error("ìœ íš¨í•œ formality ê°’ì´ ì•„ë‹™ë‹ˆë‹¤.");
      }

      if (!style) throw new Error("rewrite ëª¨ë“œì—ì„œëŠ” style ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const styleKey = `${style}ì `;
      if (!["1ì ", "2ì ", "3ì ", "4ì ", "5ì "].includes(styleKey)) {
        throw new Error("ìœ íš¨í•œ style ê°’ì´ ì•„ë‹™ë‹ˆë‹¤.");
      }

      const formalityMessages = [
        {
          role: "system",
          content: `
          ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì„ ì§€ì •ëœ ê²©ì‹ ì ìˆ˜(1~5ì  ìŠ¤í™íŠ¸ëŸ¼: ê²©ì‹ â†” ë¹„ê²©ì‹)ì— ë§ê²Œ 'ë¬¸ì²´ë§Œ' ì¬ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
          ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. 
          ì‚¬ìš©ìê°€ ì œê³µí•œ ë¬¸ì¥ì„ ê²©ì‹ ì ìˆ˜, ìŠ¤íƒ€ì¼ ì ìˆ˜ ê¸°ì¤€ì— ë”°ë¼ **ë§íˆ¬, ì–´íˆ¬, í‘œí˜„ ë°©ì‹ë§Œ ë³€ê²½**í•˜ì„¸ìš”. 
          **ì˜ë¯¸ ë³€í˜•ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.** ë¬¸ì¥ì˜ ì •ë³´ êµ¬ì¡°(ì£¼ì–´, ëª©ì ì–´, ë™ì‚¬)ëŠ” ë°˜ë“œì‹œ ìœ ì§€ë˜ì–´ì•¼ í•˜ë©°, ê°ì •ì´ë‚˜ ë‰˜ì•™ìŠ¤, ì–´ë¯¸/í˜•ì‹ë§Œ ë³€ê²½í•˜ì„¸ìš”. 
          `,
        },
        {
          role: "user",
          content: buildFormalityRewritePrompt(formalityKey, text),
        },
      ];
      const formalityResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: formalityMessages,
      });
      const formalityResult = formalityResponse.choices[0].message.content ?? "";

      const styleMessages = [
        {
          role: "system",
          content: `ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì„ ì§€ì •ëœ ìŠ¤íƒ€ì¼ ì ìˆ˜(1~5ì  ìŠ¤í™íŠ¸ëŸ¼: ê³¼ì—…ì§€í–¥ì  â†” ì‚¬íšŒì •ì„œì )ì— ë§ê²Œ 'ë¬¸ì²´ë§Œ' ì¬ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
          ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. 
          ì‚¬ìš©ìê°€ ì œê³µí•œ ë¬¸ì¥ì„ ìŠ¤íƒ€ì¼ ì ìˆ˜ ê¸°ì¤€ì— ë”°ë¼ **ë§íˆ¬, ì–´íˆ¬, í‘œí˜„ ë°©ì‹ë§Œ ë³€ê²½**í•˜ì„¸ìš”.
          **ì˜ë¯¸ ë³€í˜•ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.** ë¬¸ì¥ì˜ ì •ë³´ êµ¬ì¡°(ì£¼ì–´, ëª©ì ì–´, ë™ì‚¬)ëŠ” ë°˜ë“œì‹œ ìœ ì§€ë˜ì–´ì•¼ í•˜ë©°, ê°ì •ì´ë‚˜ ë‰˜ì•™ìŠ¤, ì–´ë¯¸/í˜•ì‹ë§Œ ë³€ê²½í•˜ì„¸ìš”.
          **ê²©ì‹ ìˆ˜ì¤€ ë³€í˜•ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.**`,
        },
        {
          role: "user",
          content: buildStyleRewritePrompt(styleKey, formalityResult), // styleëŠ” 1~5 ê°’ì´ì–´ì•¼ í•¨
        },
      ];
      const styleResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: styleMessages,
      });
      const styleResult = styleResponse.choices[0].message.content ?? "";
      return `ê²©ì‹ ìˆ˜ì¤€ ë°˜ì˜ ê²°ê³¼ \n ${formalityResult}\n\n ìŠ¤íƒ€ì¼ê¹Œì§€ ë°˜ì˜í•œ ìµœì¢… ê²°ê³¼ \n ${styleResult}`;
    }
    throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œì…ë‹ˆë‹¤. 'diagnose' ë˜ëŠ” 'rewrite' ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  }
}
export default KToneTool;

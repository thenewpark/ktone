import { MCPTool } from "mcp-framework";
import { z } from "zod";
import OpenAI from "openai";
// const openai = new OpenAI({
//   apiKey: process.env.OPENAI_API_KEY,
// }); // í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
const styleRules = {
  style: {
    "1ì ": {
      label: "ê·¹íˆ ê³¼ì—…ì§€í–¥ì ",
      nng_mapping: {
        funny_serious: "Serious",
        enthusiastic_fact: "Matter-of-fact",
      },
      description: "ê±´ì¡°í•˜ê³  ì„¤ëª…ì ì´ë©° ê°ì • í‘œí˜„ì´ ì—†ìŒ. ê¸°ëŠ¥ ì „ë‹¬ì—ë§Œ ì§‘ì¤‘.",
      features: ["ëª…ë ¹í˜• í‘œí˜„", "ê°ì • í‘œí˜„ ì—†ìŒ", "ê¸°ìˆ ì  ì–´íœ˜", "ë”±ë”±í•œ ì¢…ê²°ì–´ë¯¸"],
      examples: ["ì‹œìŠ¤í…œ ì ê²€ìœ¼ë¡œ ì¸í•´ ì ‘ì†ì´ ì œí•œë©ë‹ˆë‹¤.", "ì•±ì„ ì¢…ë£Œí•œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”."],
      context: ["í•™ìˆ  ë…¼ë¬¸", "ì—°êµ¬ ë³´ê³ ì„œ", "í–‰ì • ë¬¸ì„œ", "ê¸°ëŠ¥ ì„¤ëª…ì„œ", "ë§¤ë‰´ì–¼"],
    },
    "2ì ": {
      label: "ê³¼ì—…ì§€í–¥ì ",
      nng_mapping: {
        funny_serious: "Serious",
        enthusiastic_fact: "Slightly matter-of-fact",
      },
      description: "ì •ì¤‘í•˜ì§€ë§Œ ê°ì •ì€ ì ˆì œëœ í‘œí˜„. ê¸°ëŠ¥ ì „ë‹¬ + ë°°ë ¤ ìš”ì†Œ ì†ŒëŸ‰ í¬í•¨.",
      features: ["ì„¤ëª… ì¤‘ì‹¬", "ê²©ì‹ ìˆëŠ” í‘œí˜„", "ê°ì •ì–´ ì ˆì œ", "ì™„ê³¡ì–´ë²•"],
      examples: [
        "ì¼ì‹œì ìœ¼ë¡œ ì ‘ì†ì´ ì›í™œí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ìš©ì— ì°¸ê³  ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
        "ìš”ì²­í•˜ì‹  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
      ],
      context: ["ê³µì‹ ì´ë©”ì¼", "ì—…ë¬´ ë³´ê³ ì„œ", "ì‹œìŠ¤í…œ ë©”ì‹œì§€"],
    },
    "3ì ": {
      label: "ì¤‘ë¦½",
      nng_mapping: {
        funny_serious: "Neutral",
        enthusiastic_fact: "Neutral",
      },
      description: "ê³µê°ê³¼ ê³¼ì—…ì´ ê· í˜•ì¡íŒ ì¤‘ë¦½ì ì¸ ìŠ¤íƒ€ì¼. ì•ˆë‚´ì„±ê³¼ ë°°ë ¤ì˜ ê· í˜•.",
      features: ["ë°°ë ¤ í‘œí˜„ í¬í•¨", "ë„ˆë¬´ ë”±ë”±í•˜ì§€ ì•ŠìŒ", "ì„¤ëª…ê³¼ ê°ì •ì˜ ê· í˜•"],
      examples: [
        "ì ì‹œ ì ‘ì†ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆì–´ìš”. ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤.",
        "ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”.",
      ],
      context: ["ìê¸°ì†Œê°œì„œ", "ì •ë³´ì„± ë¸”ë¡œê·¸", "êµìœ¡ ì½˜í…ì¸ "],
    },
    "4ì ": {
      label: "ì‚¬íšŒì •ì„œì ",
      nng_mapping: {
        funny_serious: "Slightly funny",
        enthusiastic_fact: "Slightly enthusiastic",
      },
      description: "ê³µê° í‘œí˜„ì´ ë‘ë“œëŸ¬ì§€ê³ , ì •ì„œì ìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ í‘œí˜„ ì‚¬ìš©.",
      features: ["ë¶€ë“œëŸ¬ìš´ ë§íˆ¬", "ê³µê° ë¬¸êµ¬ í¬í•¨", "ìœ ì—°í•œ ì¢…ê²° ì–´ë¯¸"],
      examples: [
        "ì ‘ì†ì´ ì ì‹œ ì›í™œí•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!",
        "ì•—, ì—°ê²°ì´ ëŠê²¼ë„¤ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš” :)",
      ],
      context: ["ë¸Œëœë“œ ì†Œì…œë¯¸ë””ì–´", "ì˜¨ë¼ì¸ ì»¤ë®¤ë‹ˆí‹° ê¸€", "ì¹œê·¼í•œ ê³ ê° ì‘ëŒ€", "ê°œì¸ ì´ë©”ì¼"],
    },
    "5ì ": {
      label: "ê·¹íˆ ì‚¬íšŒì •ì„œì ",
      nng_mapping: {
        funny_serious: "Funny",
        enthusiastic_fact: "Enthusiastic",
      },
      description: "ì¹œê·¼í•˜ê³  ê°ì„±ì ì´ë©°, ìœ ì¾Œí•¨ê³¼ ë”°ëœ»í•¨ì„ ê°•ì¡°í•˜ëŠ” ìŠ¤íƒ€ì¼.",
      features: ["ê°íƒ„ì‚¬", "ì´ëª¨ì§€", "ì¹œê·¼í•œ ë§íˆ¬", "ê°ì • ê°•ì¡° í‘œí˜„"],
      examples: [
        "í—‰ ğŸ˜¢ ì ‘ì†ì´ ì ì‹œ ì•ˆ ë  ìˆ˜ ìˆì–´ìš”~ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”~!",
        "ì•—! ë¬¸ì œê°€ ìƒê²¼ë„¤ìš” ğŸ’¦ ê¸ˆë°© í•´ê²°í•´ë“œë¦´ê²Œìš” :)",
      ],
      context: ["ê°œì¸ SNS í¬ìŠ¤íŠ¸", "ì¹œêµ¬ ê°„ ë©”ì‹œì§€", "ì¼ìƒ ë¸”ë¡œê·¸"],
    },
  },
};
const formalityRules = {
  formality: {
    "1ì ": {
      label: "ë§¤ìš° ë¹„ê²©ì‹",
      description: "ë°˜ë§ ì–´ë¯¸ì™€ ììœ ë¡œìš´ í‘œí˜„ ì‚¬ìš©. ì¶•ì•½ ë° ì´ëª¨í‹°ì½˜ í—ˆìš©.",
      features: ["-ì•„, -ì–´ ì–´ë¯¸", "ì´ëª¨ì§€, ì˜ì„±ì–´", "ì£¼ì–´ ìƒëµ", "ì¸í„°ë„·ì²´"],
      examples: ["ì´ê±° í•´", "ë°¥ ë¨¹ì—ˆì–´?", "ê³ ë§ˆì›Œìš”ğŸ˜»", "ë´ë´ìš”ã…ã…"],
      context: ["ì¹œêµ¬ ëŒ€í™”", "SNS ëŒ“ê¸€", "ìºì£¼ì–¼ ì»¤ë®¤ë‹ˆí‹°"],
    },
    "2ì ": {
      label: "ë¹„ê²©ì‹",
      description: "ì¹œê·¼í•œ í•´ìš”ì²´ ì¤‘ì‹¬. êµ¬ì–´ì  í‘œí˜„ì„ í¬í•¨.",
      features: ["-í•´ìš”", "-ì£ ", "ê°íƒ„ í‘œí˜„", "ì§ì ‘ í˜¸ì¹­"],
      examples: ["ì´ê±° í•´ë´ìš”", "ê´œì°®ì•„ìš”?", "ì–´ë”” ê°€ìš”?", "ì´ê±° ì–´ë•Œìš”?"],
      context: ["ì»¤ë®¤ë‹ˆí‹°", "ê°œì¸ ë¸”ë¡œê·¸", "ì¹œê·¼í•œ ê³ ê° ì‘ëŒ€"],
    },
    "3ì ": {
      label: "ì¤‘ë¦½ì  ê²©ì‹",
      description: "ì¼ìƒì  ì¡´ëŒ€ í‘œí˜„ ì‚¬ìš©. ì„œë¹„ìŠ¤ UI ë“±ì—ì„œ í™œìš©.",
      features: ["ê¸°ë³¸ í•´ìš”ì²´", "-í•´ìš” / -í•˜ì‹œê² ì–´ìš”", "ì‚¬ìš©ì ì¤‘ì‹¬ ì•ˆë‚´"],
      examples: ["ì•ˆë‚´ ë„ì™€ë“œë¦´ê²Œìš”", "í™•ì¸í•´ ì£¼ì„¸ìš”", "ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?"],
      context: ["ê³µì‹ ë¸”ë¡œê·¸", "ì •ë³´ì„± ì½˜í…ì¸ ", "ì•±/ì›¹ ì¸í„°í˜ì´ìŠ¤"],
    },
    "4ì ": {
      label: "ê²©ì‹",
      description: "ê³µì†í•œ í•˜ì‹­ì‹œì˜¤ì²´ ì¤‘ì‹¬. ì •ì¤‘í•˜ê³  ëª…í™•í•œ ì–´ì¡°.",
      features: ["-ì‹­ì‹œì˜¤", "-ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤", "ê°„ê²°/ëª…í™•í•œ ì•ˆë‚´", "ê²©ì‹ ë†’ìŒ"],
      examples: ["ë“±ë¡í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤", "í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤", "ë¬¸ì˜ ì£¼ì‹­ì‹œì˜¤"],
      context: ["ê³µê³µê¸°ê´€", "ê³µì‹ ê³µì§€", "ê¸°ì—… ê³ ê°ì„¼í„°"],
    },
    "5ì ": {
      label: "ë§¤ìš° ê²©ì‹",
      description: "ê´€ë£Œì  í‘œí˜„ ë° ê·¹ì¡´ì¹­. ëª…ì‚¬í˜• ì„œìˆ  ê°•ì¡°.",
      features: ["ëª…ì‚¬í™”", "ì²´ì–¸í˜• í‘œí˜„", "ì£¼ì–´ ìƒëµ", "ê°•ì¡°ëœ ê°ê´€ì„±"],
      examples: ["í™•ì¸ ìš”ë§", "íšŒì‹  ë°”ëë‹ˆë‹¤", "ì¡°ì¹˜ ë°”ëë‹ˆë‹¤"],
      context: ["ë³´ê³ ì„œ", "ê³µë¬¸", "í–‰ì • ë¬¸ì„œ", "ì •ì±… ë¬¸ì„œ"],
    },
  },
};
function buildStyleRewritePrompt(style, input) {
  const rule = styleRules.style[style];
  return `
    [ì§€ì¹¨]
    [ì›ë³¸ í…ìŠ¤íŠ¸]ì„ ì•„ë˜ ìŠ¤íƒ€ì¼ì˜ ë§íˆ¬ì™€ ë¶„ìœ„ê¸°ë¡œ ë°”ê¾¸ë˜, **ì˜ë¯¸ëŠ” ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”**.
    ì¦‰, ì •ë³´, ì£¼ì–´, ë©”ì‹œì§€ì˜ í•µì‹¬ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  **ë¬¸ì²´(í†¤ê³¼ ìŠ¤íƒ€ì¼)ë§Œ ë°”ê¿” ì£¼ì„¸ìš”**.

    - í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì„ ì£¼ì–´ì§„ ìŠ¤íƒ€ì¼ ì ìˆ˜ (${style})ì— ë§ê²Œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.
    - ë‹¨, ë¬¸ì¥ì˜ **í•µì‹¬ ì˜ë¯¸ë‚˜ ì •ë³´ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”**.
    - ì „ì²´ ê¸€ì´ ìŠ¤íƒ€ì¼ìƒ ìì—°ìŠ¤ëŸ½ê³  ì¼ê´€ì„± ìˆê²Œ ì½íˆë„ë¡ ì¡°ì •í•˜ì„¸ìš”.
    - ê°€ëŠ¥í•œ í•œ **ìµœì†Œí•œì˜ ìˆ˜ì •**ìœ¼ë¡œ ìµœëŒ€í•œ ìŠ¤íƒ€ì¼ ë³€í™”ë¥¼ ìœ ë„í•˜ì„¸ìš”.

    [Style ${style} í†¤ ë³€í™˜ ìš”ì²­]
    - í†¤ ì´ë¦„: ${rule.label}
    - ì„¤ëª…: ${rule.description}
    - ìŠ¤íƒ€ì¼ ê¸°ì¤€ (NNG): Funnyâ€“Serious: ${rule.nng_mapping.funny_serious}, Enthusiasticâ€“Fact: ${
    rule.nng_mapping.enthusiastic_fact
  }
    - íŠ¹ì§•: ${rule.features.join(", ")}
    - ì˜ˆì‹œ ë¬¸ì¥: "${rule.examples[0]}"

    [ì›ë³¸ í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ìˆ˜ì •ëœ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì„œ ì¶œë ¥í•˜ì„¸ìš”.
    `;
}
function buildStyleDiagnosisPrompt(input) {
  return `
    [ì§€ì¹¨]
    ì•„ë˜ í…ìŠ¤íŠ¸ê°€ ì–´ë–¤ style ì ìˆ˜ì— ê°€ê¹Œìš´ì§€ 1~5ì ìœ¼ë¡œ íŒë‹¨í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•´ ì£¼ì„¸ìš”.

    - ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì´ 1~5ì  ì¤‘ ì–´ë–¤ ìŠ¤íƒ€ì¼ ì ìˆ˜ì— ê°€ê¹Œìš´ì§€ ì§„ë‹¨í•´ ì£¼ì„¸ìš”.
    - ì ìˆ˜ ê¸°ì¤€: 1 (ê·¹íˆ ê³¼ì—…ì§€í–¥ì ) ~ 5 (ê·¹íˆ ì‚¬íšŒì •ì„œì )
    - ì „ì²´ ë¬¸ì¥ì˜ ìŠ¤íƒ€ì¼ ì ìˆ˜ í‰ê· ì„ ì°¸ê³ í•´ ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë¥¼ ìš”ì•½í•´ ì£¼ì„¸ìš”.

    Style ê¸°ì¤€ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    ${["1ì ", "2ì ", "3ì ", "4ì ", "5ì "]
      .map((style) => {
        const s = styleRules.style[style];
        return `
          [Style ${style}]
          - ì´ë¦„: ${s.label}
          - ì„¤ëª…: ${s.description}
          - Tone ê¸°ì¤€: Funnyâ€“Serious: ${s.nng_mapping.funny_serious}, Enthusiasticâ€“Fact: ${
          s.nng_mapping.enthusiastic_fact
        }
          - íŠ¹ì§•: ${s.features.join(", ")}
          - ì˜ˆì‹œ: "${s.examples[0]}"
          `;
      })
      .join("\n")}

    [í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ì¶œë ¥í•  ë•Œì—ëŠ” ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”. 
    - ì˜ˆì¸¡ ì ìˆ˜: N
    - ì˜ˆì¸¡ ì´ë¦„: ìŠ¤íƒ€ì¼ ì´ë¦„
    - ì´ìœ : {ë‚´ìš©}
    `;
}
function buildFormalityDiagnosisPrompt(input) {
  return `
    [ì§€ì¹¨]
    ì•„ë˜ í…ìŠ¤íŠ¸ì˜ ê²©ì‹ ìˆ˜ì¤€ì´ ì–´ë–¤ ë‹¨ê³„(1~5)ì— ê°€ê¹Œìš´ì§€ íŒë‹¨í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•´ ì£¼ì„¸ìš”.

    - ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì´ 1~5ì  ì¤‘ ì–´ë–¤ ê²©ì‹ ì ìˆ˜ì— ê°€ê¹Œìš´ì§€ ì§„ë‹¨í•´ ì£¼ì„¸ìš”.
    - ì ìˆ˜ ê¸°ì¤€: 1 (ë§¤ìš° ë¹„ê²©ì‹) ~ 5 (ë§¤ìš° ê²©ì‹)
    - ì „ì²´ ë¬¸ì¥ì˜ ê²©ì‹ ì ìˆ˜ í‰ê· ì„ ì°¸ê³ í•´ ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë¥¼ ìš”ì•½í•´ ì£¼ì„¸ìš”.

    Formality ê¸°ì¤€ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    ${["1ì ", "2ì ", "3ì ", "4ì ", "5ì "]
      .map((score) => {
        const f = formalityRules.formality[score];
        return `
          [Formality ${score}]
          - ì´ë¦„: ${f.label}
          - ì„¤ëª…: ${f.description}
          - íŠ¹ì§•: ${f.features.join(", ")}
          - ì˜ˆì‹œ: "${f.examples[0]}"`;
      })
      .join("\n\n")}

    [í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ì¶œë ¥í•  ë•Œì—ëŠ” ì „ì²´ í…ìŠ¤íŠ¸ì˜ í‰ê·  ì ìˆ˜ì™€ ì´ìœ ë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”. 
    - ì˜ˆì¸¡ ì ìˆ˜: N
    - ì˜ˆì¸¡ ì´ë¦„: ê²©ì‹ ìˆ˜ì¤€ ì´ë¦„
    - ì´ìœ : {ë‚´ìš©}
  `.trim();
}
function buildFormalityRewritePrompt(score, input) {
  const rule = formalityRules.formality[score];
  return `
    [ì§€ì¹¨]
    [ì›ë³¸ í…ìŠ¤íŠ¸]ë¥¼ ì•„ë˜ ê²©ì‹ ìˆ˜ì¤€ìœ¼ë¡œ ë°”ê¾¸ë˜, **ì˜ë¯¸ëŠ” ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”**.
    ì¦‰, ì •ë³´, ì£¼ì–´, ë©”ì‹œì§€ì˜ í•µì‹¬ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  **ë¬¸ì²´(í†¤ê³¼ ìŠ¤íƒ€ì¼)ë§Œ ë°”ê¿” ì£¼ì„¸ìš”**.

    - í…ìŠ¤íŠ¸ë¥¼ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•´ ì£¼ì„¸ìš”.
    - ê° ë¬¸ì¥ì„ ì£¼ì–´ì§„ ê²©ì‹ ì ìˆ˜ (${score})ì— ë§ê²Œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.
    - ë‹¨, ë¬¸ì¥ì˜ **í•µì‹¬ ì˜ë¯¸ë‚˜ ì •ë³´ êµ¬ì¡°ëŠ” ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”**.
    - ì „ì²´ ê¸€ì´ ê²©ì‹ìƒ ìì—°ìŠ¤ëŸ½ê³  ì¼ê´€ì„± ìˆê²Œ ì½íˆë„ë¡ ì¡°ì •í•˜ì„¸ìš”.
    - ê°€ëŠ¥í•œ í•œ **ìµœì†Œí•œì˜ ìˆ˜ì •**ìœ¼ë¡œ ê²©ì‹ ë³€í™”ë¥¼ ìœ ë„í•˜ì„¸ìš”.

    [Formality ${score}ë²ˆ í†¤ ë³€í™˜ ìš”ì²­]
    - í†¤ ì´ë¦„: ${rule.label}
    - ì„¤ëª…: ${rule.description}
    - íŠ¹ì§•: ${rule.features.join(", ")}
    - ì˜ˆì‹œ ë¬¸ì¥: "${rule.examples.join(", ")}"

    [ì›ë³¸ í…ìŠ¤íŠ¸]
    "${input}"

    [ì¶œë ¥ í˜•ì‹]
    ìˆ˜ì •ëœ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì„œ ì¶œë ¥í•˜ì„¸ìš”.
  `.trim();
}
export class KToneTool extends MCPTool {
  constructor() {
    super(...arguments);
    this.name = "ktone";
    this.description = "í…ìŠ¤íŠ¸ì˜ í†¤ì„ ë¶„ì„í•˜ê±°ë‚˜, ì§€ì •í•œ í†¤ìœ¼ë¡œ ë¦¬ë¼ì´íŒ…í•©ë‹ˆë‹¤.";
    this.schema = {
      text: {
        type: z.string(),
        description: "ë¶„ì„í•  í•œêµ­ì–´ ë¬¸ì¥",
      },
      mode: {
        type: z.enum(["diagnose", "rewrite"]),
        description: "ëª¨ë“œ: diagnose ë˜ëŠ” rewrite",
      },
      style: {
        type: z.union([z.literal("1"), z.literal("2"), z.literal("3"), z.literal("4"), z.literal("5")]).optional(),
        description: "ëª©í‘œ ìŠ¤íƒ€ì¼ ì ìˆ˜ (1~5)",
      },
      formality: {
        type: z.union([z.literal("1"), z.literal("2"), z.literal("3"), z.literal("4"), z.literal("5")]).optional(),
        description: "ëª©í‘œ ê²©ì‹ ì ìˆ˜ (1~5)",
      },
    };
  }
  async execute({ text, style, mode, formality, apiKey }) {
    const openai = new OpenAI({
      apiKey,
    }); // í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°

    if (mode === "diagnose") {
      // 1 ê²©ì‹ í†¤ ë¶„ì„
      const formalityMessages = [
        {
          role: "system",
          content: `
          ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì˜ ë¹„ê²©ì‹-ê²©ì‹ ìˆ˜ì¤€ì„ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
          ê° ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
          `,
        },
        {
          role: "user",
          content: buildFormalityDiagnosisPrompt(text),
        },
      ];
      const formalityResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: formalityMessages,
      });
      const formalityResult = formalityResponse.choices[0].message.content ?? "";
      // 2 ìŠ¤íƒ€ì¼ í†¤ ë¶„ì„
      const styleMessages = [
        {
          role: "system",
          content: `
          ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì˜ ìŠ¤íƒ€ì¼ì„ 1~5ì ì˜ ìŠ¤í™íŠ¸ëŸ¼(ì‚¬íšŒì •ì„œì  â†” ê³¼ì—…ì§€í–¥ì )ìœ¼ë¡œ í‰ê°€í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
          ê° ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. 
          ì´ì „ ë‹¨ê³„ì—ì„œ formality í†¤ ë¶„ì„ ê²°ê³¼ë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”.`,
        },
        {
          role: "user",
          content: buildStyleDiagnosisPrompt(formalityResult),
        },
      ];
      const styleResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: styleMessages,
      });
      const styleResult = styleResponse.choices[0].message.content ?? "";
      return `${formalityResult}\n\n${styleResult}`;
    }
    if (mode === "rewrite") {
      // 1 ê²©ì‹ í†¤ ë³€í™˜
      if (!formality) throw new Error("rewrite ëª¨ë“œì—ì„œëŠ” formality ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const formalityKey = `${formality}ì `;
      if (!["1ì ", "2ì ", "3ì ", "4ì ", "5ì "].includes(formalityKey)) {
        throw new Error("ìœ íš¨í•œ formality ê°’ì´ ì•„ë‹™ë‹ˆë‹¤.");
      }
      const formalityMessages = [
        {
          role: "system",
          content: `ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì„ ì§€ì •ëœ ê²©ì‹ ì ìˆ˜(1~5ì  ìŠ¤í™íŠ¸ëŸ¼: ë¹„ê²©ì‹ â†” ê²©ì‹)ì— ë§ê²Œ 'ë¬¸ì²´ë§Œ' ì¬ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
          ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì œê³µí•œ ë¬¸ì¥ì„ ê²©ì‹ ì ìˆ˜ ê¸°ì¤€ì— ë”°ë¼ **ë§íˆ¬, ì–´íˆ¬, í‘œí˜„ ë°©ì‹ë§Œ ë³€ê²½**í•˜ì„¸ìš”. 
          **ì˜ë¯¸ ë³€í˜•ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.** ë¬¸ì¥ì˜ ì •ë³´ êµ¬ì¡°(ì£¼ì–´, ëª©ì ì–´, ë™ì‚¬)ëŠ” ë°˜ë“œì‹œ ìœ ì§€ë˜ì–´ì•¼ í•˜ë©°, ì–´ë¯¸/í˜•ì‹ë§Œ ë³€ê²½í•˜ì„¸ìš”.`,
        },
        {
          role: "user",
          content: buildFormalityRewritePrompt(formalityKey, text),
        },
      ];
      const formalityResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: formalityMessages,
      });
      const formalityResult = formalityResponse.choices[0].message.content ?? "";

      // 2 ìŠ¤íƒ€ì¼ í†¤ ë³€í™˜
      if (!style) throw new Error("rewrite ëª¨ë“œì—ì„œëŠ” style ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      const styleKey = `${style}ì `;
      if (!["1ì ", "2ì ", "3ì ", "4ì ", "5ì "].includes(styleKey)) {
        throw new Error("ìœ íš¨í•œ style ê°’ì´ ì•„ë‹™ë‹ˆë‹¤.");
      }
      const styleMessages = [
        {
          role: "system",
          content: `ë‹¹ì‹ ì€ í•œêµ­ì–´ ë¬¸ì¥ì„ ì§€ì •ëœ ìŠ¤íƒ€ì¼ ì ìˆ˜(1~5ì  ìŠ¤í™íŠ¸ëŸ¼: ì‚¬íšŒì •ì„œì  â†” ê³¼ì—…ì§€í–¥ì )ì— ë§ê²Œ 'ë¬¸ì²´ë§Œ' ì¬ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
          ì ìˆ˜ì˜ ê¸°ì¤€ì€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì œê³µí•œ ë¬¸ì¥ì„ ìŠ¤íƒ€ì¼ ì ìˆ˜ ê¸°ì¤€ì— ë”°ë¼ **ë§íˆ¬, ì–´íˆ¬, í‘œí˜„ ë°©ì‹ë§Œ ë³€ê²½**í•˜ì„¸ìš”.
          **ì˜ë¯¸ ë³€í˜•ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.** ë¬¸ì¥ì˜ ì •ë³´ êµ¬ì¡°(ì£¼ì–´, ëª©ì ì–´, ë™ì‚¬)ëŠ” ë°˜ë“œì‹œ ìœ ì§€ë˜ì–´ì•¼ í•˜ë©°, ê°ì •ì´ë‚˜ ë‰˜ì•™ìŠ¤, ì–´ë¯¸/í˜•ì‹ë§Œ ë³€ê²½í•˜ì„¸ìš”. 
          **ê²©ì‹ ìˆ˜ì¤€ ë³€í˜•ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.**`,
        },
        {
          role: "user",
          content: buildStyleRewritePrompt(styleKey, formalityResult), // styleëŠ” 1~5 ê°’ì´ì–´ì•¼ í•¨
        },
      ];
      const styleResponse = await openai.chat.completions.create({
        model: "gpt-4-turbo",
        temperature: 0.2,
        messages: styleMessages,
      });
      const styleResult = styleResponse.choices[0].message.content ?? "";
      return `${styleResult}`;
    }
    throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œì…ë‹ˆë‹¤. 'diagnose' ë˜ëŠ” 'rewrite' ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  }
}
export default KToneTool;
